java虚拟机管理的内存将分为下面五大区域。

> 其中方法区和堆是所有线程共享的，栈，本地方法栈和程序计数器则为线程私有的。

![img](https://upload-images.jianshu.io/upload_images/10006199-a4108d8fb7810a71.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000)



每个区域存储的内容：

![img](https://user-gold-cdn.xitu.io/2017/9/4/da77d90146786c0cb3e170b9c9376ae4?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



### 1、运行时数据区



#### 1.1程序计数器

> 内存空间小，线程私有。字节码解释器工作是就是通过改变这个计数器的值来选取下一条需要执行指令的字节码指令，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖计数器完成
>
> 为什么需要程序计数器：
>
> ​		对于一个处理器(如果是多核cpu那就是一核)，在一个确定的时刻都只会执行一条线程中的指令，一条线程中有多个指令，为了线程切换可以恢复到正确执行位置，每个线程都需有独立的一个程序计数器，不同线程之间的程序计数器互不影响，独立存储。

​		如果线程正在执行一个 Java 方法，这个计数器记录的是正在执行的虚拟机字节码指令的地址；如果正在执行的是 Native 方法，这个计数器的值则为 (Undefined)。此内存区域是唯一一个在 Java 虚拟机规范中没有规定任何 OutOfMemoryError 情况的区域。



#### 1.2  Java 虚拟机栈

一个栈帧对应于某个类中某个方法的执行模型。方法区里面存的就是这个方法的字节码地址。

> ​		线程私有，生命周期和线程一致。描述的是 Java 方法执行的内存模型：每个方法在执行时都会床创建一个栈帧(Stack Frame)用于存储`局部变量表`、`操作数栈`、`动态链接`、`方法出口`等信息。每一个方法从调用直至执行结束，就对应着一个栈帧从虚拟机栈中入栈到出栈的过程。

局部变量表：

> ​		一片连续的内存空间，用来存放方法参数，以及方法内定义的局部变量，存放着编译期间已知的数据类型(八大基本类型和对象引用(reference类型),returnAddress类型。它的最小的局部变量表空间单位为Slot，虚拟机没有指明Slot的大小，但在jvm中，long和double类型数据明确规定为64位，这两个类型占2个Slot，其它基本类型固定占用1个Slot。

操作数栈：

> java虚拟机栈中的一个用于计算的临时数据存储区。

动态连接：

> ​		动态连接是一个将符号引用解析为直接引用的过程。当java虚拟机执行字节码时，如果它遇到一个操作码，这个操作码第一次使用一个指向另一个类的符号引用,那么虚拟机就必须解析这个符号引用。在解析时，虚拟机执行两个基本任务：
>
> 1.查找被引用的类，（如果必要的话就装载它）
>
> 2.将符号引用替换为直接引用，这样当它以后再次遇到相同的引用时，它就可以立即使用这个直接引用，而不必花时间再次解析这个符号引用了。

方法出口：

> 指向一条字节码指令的地址



栈帧的位置？

> 内存 -> 运行时数据区 -> 某个线程对应的虚拟机栈 -> 这里就是栈帧了



栈的执行过程：

![img](https://upload-images.jianshu.io/upload_images/10006199-728567b81e7abff5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000)



> Java虚拟机栈可能出现两种类型的异常：
>
> 1. 线程请求的栈深度大于虚拟机允许的栈深度，将抛出StackOverflowError。
> 2. 虚拟机栈空间可以动态扩展，当动态扩展是无法申请到足够的空间时，抛出OutOfMemory异常。



#### 1.3 本地方法栈

> ​		本地方法栈是与虚拟机栈发挥的作用十分相似,区别是虚拟机栈执行的是Java方法(也就是字节码)服务，而本地方法栈则为虚拟机使用到的native方法服务，可能底层调用的c或者c++。



#### 1.4 Java 堆

> ​		java虚拟机规范对这块的描述是:所有对象实例及数组都要在堆上分配内存，但随着JIT编译器的发展和逃逸分析技术的成熟，这个说法也不是那么绝对，但是大多数情况都是这样的。
>
> ​		Java堆可以存在物理上不连续的内存空间，就像磁盘空间只要逻辑是连续的即可。它的内存大小可以设为固定大小，也可以扩展。



#### 1.5 方法区

> ​		用于存储已被虚拟机加载的类信息、常量、静态变量，如static修饰的变量加载类的时候就被加载到方法区中。

在老版jdk，方法区也被称为永久代，不过自从JDK7之后，Hotspot虚拟机便将运行时常量池从永久代移除了

注意：方法区存的是类信息，而虚拟机栈里面存的则是 java 方法执行的内存模型。



### 2、HotSpot 虚拟机对象

